<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>早睡早起基金 · 仪表盘</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --muted:#96a0c6;
      --text:#e9ecff;
      --line:rgba(255,255,255,.12);
      --blank:rgba(255,255,255,.08);
      --good:#2ecc71;
      --bad:#ff4d4f;
      --chip:#1a2550;
      --shadow:0 14px 30px rgba(0,0,0,.35);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 15% 10%, rgba(76,99,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(46,204,113,.18), transparent 55%),
                  radial-gradient(900px 700px at 65% 90%, rgba(255,77,79,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:28px 14px;
    }

    .app{width:min(1050px, 100%);}

    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }

    .brand{display:flex;gap:12px;align-items:center;}
    .logo{
      width:44px;height:44px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(76,99,255,.9), rgba(46,204,113,.75));
      box-shadow: var(--shadow);
      display:grid;
      place-items:center;
      font-weight:800;
      letter-spacing:.5px;
    }
    .brand h1{margin:0;font-size:18px;line-height:1.1;}
    .brand p{margin:0;color:var(--muted);font-size:12px;}

    .toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.09)}
    .btn:active{transform: translateY(0px)}

    .monthTitle{
      font-weight:700;
      padding:10px 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius:14px;
      min-width: 170px;
      text-align:center;
    }

    .layout{display:grid;grid-template-columns: 1fr 320px;gap:14px;}
    @media (max-width: 960px){.layout{grid-template-columns: 1fr;}}

    .card{
      background: rgba(18,26,51,.88);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(8px);
    }

    .cardHeader{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:12px;}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;vertical-align:middle}

    .grid{display:grid;grid-template-columns: repeat(7, 1fr);}
    .dow{padding:10px 10px;font-size:12px;color:var(--muted);border-bottom:1px solid var(--line);text-align:center;background: rgba(255,255,255,.03);}

    .cell{
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
      padding:10px;
      min-height:106px;
      position:relative;
      overflow:hidden;
    }
    .cell:nth-child(7n){border-right:none;}

    .dateNum{font-size:12px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .badgeToday{font-size:11px;padding:2px 8px;border-radius:999px;background: rgba(76,99,255,.25);border:1px solid rgba(76,99,255,.35);color:#cfd6ff;}

    .twoSlots{display:grid;grid-template-columns: 1fr;gap:8px;}

    .slot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: var(--blank);
      user-select:none;
    }
    .slot .label{font-size:12px;color:#d7dcff;display:flex;align-items:center;gap:8px;}
    .slot .stateText{font-size:12px;color:var(--muted)}

    /* 右侧指示圆点（桌面端也显示，但不突兀） */
    .indicator{
      width:10px;height:10px;border-radius:999px;flex:0 0 auto;
      background: rgba(255,255,255,.28);
      box-shadow: 0 0 0 2px rgba(0,0,0,.12) inset;
    }
    .slot.good .indicator{background: rgba(46,204,113,.95);}
    .slot.bad  .indicator{background: rgba(255,77,79,.96);}
    .slot.blank .indicator{background: rgba(255,255,255,.28);}

    .slot.good{background: rgba(46,204,113,.18); border-color: rgba(46,204,113,.35)}
    .slot.good .stateText{color: rgba(46,204,113,.95)}
    .slot.bad{background: rgba(255,77,79,.18); border-color: rgba(255,77,79,.38)}
    .slot.bad .stateText{color: rgba(255,77,79,.96)}
    .slot.blank{background: rgba(255,255,255,.06);}

    .cell.dim{opacity:.45;}

    .side{padding:14px;display:flex;flex-direction:column;gap:12px;}

    .metric{padding:12px;border:1px solid var(--line);border-radius:16px;background: rgba(255,255,255,.05);}
    .metric .k{color:var(--muted); font-size:12px;}
    .metric .v{font-size:22px; font-weight:800; margin-top:6px;}
    .metric .sub{margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;}

    .pill{background: var(--chip);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:6px;}

    .footer{margin-top:12px;color:rgba(255,255,255,.55);font-size:12px;text-align:center;}

    /* ===== Mobile (<= 560px): 日历只显示红/绿/灰点 + 小标签 ===== */
    @media (max-width: 560px){
      body{ padding:14px 10px; }
      .topbar{ flex-direction: column; align-items: stretch; gap:10px; }
      .toolbar{ justify-content: space-between; gap:8px; }
      .monthTitle{ min-width: 120px; padding:8px 10px; font-size:12px; }
      .btn{ padding:8px 10px; border-radius:12px; font-size:12px; gap:6px; }

      .cardHeader{
        padding:12px 12px;
        flex-direction: column;
        align-items: flex-start;
        gap:8px;
      }
      .legend{ font-size:11px; gap:8px; }

      .cell{
        padding:6px;
        min-height:auto;
        height: clamp(72px, 14.2vw, 92px);
      }
      .twoSlots{ gap:6px; }

      /* 重点：移动端隐藏“成功/失败/未填”文字，只保留颜色点 + “睡/起”标签 */
      .slot{
        padding:5px 7px;        /* 更薄 */
        border-radius:10px;
        background: rgba(255,255,255,.05);
      }
      .slot .stateText{ display:none; }

      /* 标签变得更像小胶囊 */
      .slot .label{
        font-size:11px;
        color:#dbe1ff;
      }

      /* 让“睡/起”更像 badge（通过 JS 注入的 span.tag） */
      .tag{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        width:20px;height:20px;
        border-radius:999px;
        background: rgba(255,255,255,.08);
        border:1px solid rgba(255,255,255,.12);
        color:#cfd6ff;
        font-size:11px;
        flex:0 0 auto;
      }

      .indicator{
        width:12px;height:12px;
        box-shadow: 0 0 0 2px rgba(0,0,0,.18) inset;
      }

      .side{ padding:12px; gap:10px; }
      .metric{ padding:10px; border-radius:14px; }
      .metric .v{ font-size:20px; }
      .pill{ padding:5px 8px; font-size:11px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo">Z</div>
        <div>
          <h1>早睡早起基金 · 仪表盘</h1>
          <p>（只读）</p>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn" id="prevMonth">◀ 上个月</button>
        <div class="monthTitle" id="monthTitle">—</div>
        <button class="btn" id="nextMonth">下个月 ▶</button>
        <button class="btn" id="jumpToday">回到今天</button>
      </div>
    </div>

    <div class="layout">
      <div class="card">
        <div class="cardHeader">
          <div style="font-weight:700">日历（只读）</div>
          <div class="legend">
            <span><span class="dot" style="background:rgba(255,255,255,.35)"></span>空白：0</span>
            <span><span class="dot" style="background:var(--good)"></span>绿色：-1</span>
            <span><span class="dot" style="background:var(--bad)"></span>红色：+1</span>
            <span style="opacity:.85">（移动端：格子里只看红/绿点）</span>
          </div>
        </div>

        <div class="grid" id="dowRow"></div>
        <div class="grid" id="calendarGrid"></div>
      </div>

      <div class="card side">
        <div class="metric">
          <div class="k">总计收益（红+1，绿-1，可为负数）</div>
          <div class="v" id="totalScore">0</div>
          <div class="sub">
            <span class="pill"><span class="dot" style="background:var(--good)"></span>绿色次数：<b id="goodCount">0</b></span>
            <span class="pill"><span class="dot" style="background:var(--bad)"></span>红色次数：<b id="badCount">0</b></span>
            <span class="pill"><span class="dot" style="background:rgba(255,255,255,.35)"></span>未填：<b id="blankCount">0</b></span>
          </div>
        </div>

        <div class="metric">
          <div class="k">本月收益（当前视图月份）</div>
          <div class="v" id="monthScore">0</div>
          <div class="sub">
            <span class="pill">月份：<b id="monthKey">—</b></span>
            <span class="pill">记录天数：<b id="monthDays">0</b></span>
          </div>
        </div>

        <div class="metric">
          <div class="k">当日应结（昨日早睡 + 今日早起）</div>
          <div class="v" id="dailyDue">0</div>
          <div class="sub">
            <span class="pill">今日：<b id="dueToday">—</b></span>
            <span class="pill">昨日：<b id="duePrev">—</b></span>
          </div>
        </div>

        <div class="metric">
          <div class="k">结款（来自 data.json）</div>
          <div class="v" id="unsettled">0</div>
          <div class="sub">
            <span class="pill">已结至：<b id="settledAt">未结</b></span>
            <span class="pill">已结金额：<b id="settledAmount">0</b></span>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">数据源：仓库根目录 data.json</div>
  </div>

  <script>
    const pad2 = (n) => String(n).padStart(2, "0");
    const toISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const monthKey = (y,m) => `${y}-${pad2(m+1)}`;

    // ====== DOM ======
    const monthTitleEl = document.getElementById("monthTitle");
    const gridEl = document.getElementById("calendarGrid");
    const dowRowEl = document.getElementById("dowRow");

    const totalScoreEl = document.getElementById("totalScore");
    const goodCountEl = document.getElementById("goodCount");
    const badCountEl = document.getElementById("badCount");
    const blankCountEl = document.getElementById("blankCount");

    const monthScoreEl = document.getElementById("monthScore");
    const monthKeyEl = document.getElementById("monthKey");
    const monthDaysEl = document.getElementById("monthDays");

    const dailyDueEl = document.getElementById("dailyDue");
    const dueTodayEl = document.getElementById("dueToday");
    const duePrevEl = document.getElementById("duePrev");

    const unsettledEl = document.getElementById("unsettled");
    const settledAtEl = document.getElementById("settledAt");
    const settledAmountEl = document.getElementById("settledAmount");

    // ====== 状态 ======
    let state = { version: 1, data: {}, settlement: { settledTotal: 0, settledAt: "" } };

    const today = new Date();
    let viewYear = today.getFullYear();
    let viewMonth = today.getMonth();

    // ====== 规则 ======
    function scoreOf(status){
      if(status === 1) return -1; // 成功（绿）
      if(status === 2) return +1; // 失败（红）
      return 0;                   // 未填（灰）
    }
    function stateLabel(s){
      if(s===1) return "成功 ✅";
      if(s===2) return "失败 ❌";
      return "未填";
    }

    function addDaysISO(iso, delta){
      const [y,m,d] = iso.split('-').map(Number);
      const dt = new Date(y, m-1, d);
      dt.setDate(dt.getDate() + delta);
      return toISO(dt);
    }

    // 当日应结：昨日早睡 + 今日早起
    function computeDailyDue(iso){
      const prev = addDaysISO(iso, -1);
      const prevDay = state.data[prev] || { sleep:0, wake:0 };
      const curDay  = state.data[iso]  || { sleep:0, wake:0 };
      return scoreOf(prevDay.sleep ?? 0) + scoreOf(curDay.wake ?? 0);
    }

    // ====== 读取 data.json（失败则静默显示空数据） ======
    async function loadData(){
      try{
        const res = await fetch("./data.json", { cache: "no-store" });
        if(!res.ok) return;
        const j = await res.json();
        if(!j || typeof j !== "object") return;
        if(!j.data) j.data = {};
        if(!j.settlement) j.settlement = { settledTotal: 0, settledAt: "" };
        state = j;
      }catch{ /* 静默 */ }
    }

    function computeTotals(){
      let total=0, good=0, bad=0, blank=0;
      for(const iso in state.data){
        const d = state.data[iso] || {};
        for(const k of ["sleep","wake"]){
          const s = d[k] ?? 0;
          total += scoreOf(s);
          if(s===1) good++; else if(s===2) bad++; else blank++;
        }
      }
      return { total, good, bad, blank };
    }

    function computeMonth(){
      const mk = monthKey(viewYear, viewMonth);
      let score=0;
      let daysSet = new Set();
      for(const iso in state.data){
        if(iso.startsWith(mk)){
          const d = state.data[iso] || {};
          score += scoreOf(d.sleep ?? 0) + scoreOf(d.wake ?? 0);
          daysSet.add(iso);
        }
      }
      return { mk, score, days: daysSet.size };
    }

    function updateSidebar(){
      const { total, good, bad, blank } = computeTotals();
      totalScoreEl.textContent = String(total);
      goodCountEl.textContent = String(good);
      badCountEl.textContent = String(bad);
      blankCountEl.textContent = String(blank);

      const m = computeMonth();
      monthScoreEl.textContent = String(m.score);
      monthKeyEl.textContent = m.mk;
      monthDaysEl.textContent = String(m.days);

      // —— 当日应结（昨日早睡 + 今日早起） ——
      const isoToday = toISO(new Date());
      const isoPrev  = addDaysISO(isoToday, -1);
      const dailyDue = computeDailyDue(isoToday);
      dailyDueEl.textContent = String(dailyDue);
      dueTodayEl.textContent = isoToday;
      duePrevEl.textContent = isoPrev;

      const settledTotal = state.settlement?.settledTotal || 0;
      const unsettled = total - settledTotal;
      unsettledEl.textContent = String(unsettled);
      settledAmountEl.textContent = String(settledTotal);
      settledAtEl.textContent = state.settlement?.settledAt ? state.settlement.settledAt : "未结";

      // 颜色提示（<=0 代表“赚”）
      totalScoreEl.style.color = (total <= 0) ? "rgba(46,204,113,.95)" : "rgba(255,77,79,.96)";
      monthScoreEl.style.color = (m.score <= 0) ? "rgba(46,204,113,.95)" : "rgba(255,77,79,.96)";
      unsettledEl.style.color = (unsettled <= 0) ? "rgba(46,204,113,.95)" : "rgba(255,77,79,.96)";
      dailyDueEl.style.color = (dailyDue <= 0) ? "rgba(46,204,113,.95)" : "rgba(255,77,79,.96)";
    }

    // ====== 渲染 ======
    const DOW = ["一","二","三","四","五","六","日"]; // 周一开始

    function renderDow(){
      dowRowEl.innerHTML = "";
      for(const d of DOW){
        const el = document.createElement("div");
        el.className = "dow";
        el.textContent = "周" + d;
        dowRowEl.appendChild(el);
      }
    }

    function makeSlot(label, shortTag, status){
      const slot = document.createElement("div");
      slot.className = "slot " + (status===1?"good":status===2?"bad":"blank");

      const l = document.createElement("div");
      l.className = "label";

      // 给移动端用的小圆标签：睡 / 起
      const tag = document.createElement("span");
      tag.className = "tag";
      tag.textContent = shortTag;

      const text = document.createElement("span");
      text.textContent = label;

      l.appendChild(tag);
      l.appendChild(text);

      const r = document.createElement("div");
      r.className = "stateText";
      r.textContent = stateLabel(status);

      const ind = document.createElement("span");
      ind.className = "indicator";

      slot.appendChild(l);
      slot.appendChild(r);
      slot.appendChild(ind);

      return slot;
    }

    function renderCalendar(){
      monthTitleEl.textContent = `${viewYear} 年 ${viewMonth+1} 月`;

      const first = new Date(viewYear, viewMonth, 1);
      const firstDay = first.getDay();
      const offset = (firstDay === 0) ? 6 : (firstDay - 1);

      gridEl.innerHTML = "";
      const startDate = new Date(viewYear, viewMonth, 1 - offset);

      for(let i=0;i<42;i++){
        const d = new Date(startDate);
        d.setDate(startDate.getDate()+i);

        const iso = toISO(d);
        const inMonth = d.getMonth() === viewMonth;
        const isToday = iso === toISO(new Date());

        const cell = document.createElement("div");
        cell.className = "cell" + (inMonth ? "" : " dim");

        const header = document.createElement("div");
        header.className = "dateNum";

        const left = document.createElement("span");
        left.textContent = d.getDate();
        header.appendChild(left);

        if(isToday){
          const b = document.createElement("span");
          b.className = "badgeToday";
          b.textContent = "今天";
          header.appendChild(b);
        } else {
          header.appendChild(document.createElement("span"));
        }

        const two = document.createElement("div");
        two.className = "twoSlots";

        const day = state.data[iso] || { sleep:0, wake:0 };
        two.appendChild(makeSlot("早睡", "睡", day.sleep ?? 0));
        two.appendChild(makeSlot("早起", "起", day.wake ?? 0));

        cell.appendChild(header);
        cell.appendChild(two);
        gridEl.appendChild(cell);
      }

      updateSidebar();
    }

    // ====== 交互按钮 ======
    document.getElementById("prevMonth").addEventListener("click", ()=>{
      viewMonth--;
      if(viewMonth<0){ viewMonth=11; viewYear--; }
      renderCalendar();
    });

    document.getElementById("nextMonth").addEventListener("click", ()=>{
      viewMonth++;
      if(viewMonth>11){ viewMonth=0; viewYear++; }
      renderCalendar();
    });

    document.getElementById("jumpToday").addEventListener("click", ()=>{
      const t = new Date();
      viewYear = t.getFullYear();
      viewMonth = t.getMonth();
      renderCalendar();
    });

    // ====== 启动 ======
    (async function boot(){
      renderDow();
      await loadData();
      renderCalendar();
    })();
  </script>
</body>
</html>
