<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>早睡早起基金 · 编辑器（本地）</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --muted:#96a0c6;
      --text:#e9ecff;
      --line:rgba(255,255,255,.12);
      --blank:rgba(255,255,255,.08);
      --good:#2ecc71;
      --bad:#ff4d4f;
      --chip:#1a2550;
      --shadow:0 14px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 15% 10%, rgba(76,99,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(46,204,113,.18), transparent 55%),
                  radial-gradient(900px 700px at 65% 90%, rgba(255,77,79,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:28px 14px;
    }
    .app{width:min(1050px, 100%);}
    .topbar{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:14px;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(76,99,255,.9), rgba(46,204,113,.75));
      box-shadow: var(--shadow);
      display:grid;place-items:center;font-weight:800;letter-spacing:.5px;
    }
    .brand h1{margin:0;font-size:18px;line-height:1.1;}
    .brand p{margin:0;color:var(--muted);font-size:12px;}
    .toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.09)}
    .btn:active{transform: translateY(0px)}
    .btnPrimary{background: rgba(76,99,255,.22);border-color: rgba(76,99,255,.35);}
    .btnDanger{background: rgba(255,77,79,.18);border-color: rgba(255,77,79,.35);}
    .monthTitle{
      font-weight:700;padding:10px 14px;border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius:14px;min-width: 170px;text-align:center;
    }
    .layout{display:grid;grid-template-columns: 1fr 320px;gap:14px;}
    @media (max-width: 960px){.layout{grid-template-columns: 1fr;}}
    .card{
      background: rgba(18,26,51,.88);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(8px);
    }
    .cardHeader{
      padding:14px 16px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:12px;}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;vertical-align:middle}
    .grid{display:grid;grid-template-columns: repeat(7, 1fr);}
    .dow{padding:10px 10px;font-size:12px;color:var(--muted);border-bottom:1px solid var(--line);text-align:center;background: rgba(255,255,255,.03);}
    .cell{border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:10px;min-height:106px;position:relative;overflow:hidden;}
    .cell:nth-child(7n){border-right:none;}
    .dateNum{font-size:12px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .badgeToday{font-size:11px;padding:2px 8px;border-radius:999px;background: rgba(76,99,255,.25);border:1px solid rgba(76,99,255,.35);color:#cfd6ff;}
    .twoSlots{display:grid;grid-template-columns: 1fr;gap:8px;}
    .slot{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:8px 10px;border-radius:14px;border:1px solid var(--line);
      background: var(--blank);
      cursor:pointer;
      user-select:none;
      transition:.12s ease;
    }
    .slot:hover{transform: translateY(-1px);}
    .slot .label{font-size:12px;color:#d7dcff;}
    .slot .stateText{font-size:12px;color:var(--muted)}
    .slot.good{background: rgba(46,204,113,.18); border-color: rgba(46,204,113,.35)}
    .slot.good .stateText{color: rgba(46,204,113,.95)}
    .slot.bad{background: rgba(255,77,79,.18); border-color: rgba(255,77,79,.38)}
    .slot.bad .stateText{color: rgba(255,77,79,.96)}
    .slot.blank{background: rgba(255,255,255,.06);}
    .cell.dim{opacity:.45;}
    .side{padding:14px;display:flex;flex-direction:column;gap:12px;}
    .metric{padding:12px;border:1px solid var(--line);border-radius:16px;background: rgba(255,255,255,.05);}
    .metric .k{color:var(--muted); font-size:12px;}
    .metric .v{font-size:22px; font-weight:800; margin-top:6px;}
    .metric .sub{margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;}
    .pill{background: var(--chip);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:6px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .footer{margin-top:12px;color:rgba(255,255,255,.55);font-size:12px;text-align:center;}
    .toast{
      position: fixed;left: 50%;bottom: 16px;transform: translateX(-50%);
      background: rgba(18,26,51,.95);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;border-radius:14px;box-shadow: var(--shadow);
      opacity: 0;pointer-events: none;transition: .18s ease;
      color: var(--text);font-size: 12px;max-width: min(520px, calc(100% - 24px));
      text-align:center;
    }
    .toast.show{opacity: 1; transform: translateX(-50%) translateY(-4px)}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo">Z</div>
        <div>
          <h1>早睡早起基金 · 编辑器</h1>
          <p>点击格子循环：未填 → 成功(绿) → 失败(红)；导出后覆盖仓库 data.json</p>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn" id="prevMonth">◀ 上个月</button>
        <div class="monthTitle" id="monthTitle">—</div>
        <button class="btn" id="nextMonth">下个月 ▶</button>
        <button class="btn btnPrimary" id="jumpToday">回到今天</button>
      </div>
    </div>

    <div class="layout">
      <div class="card">
        <div class="cardHeader">
          <div style="font-weight:700">日历（可编辑）</div>
          <div class="legend">
            <span><span class="dot" style="background:rgba(255,255,255,.35)"></span>空白</span>
            <span><span class="dot" style="background:var(--good)"></span>绿色：-1</span>
            <span><span class="dot" style="background:var(--bad)"></span>红色：+1</span>
          </div>
        </div>

        <div class="grid" id="dowRow"></div>
        <div class="grid" id="calendarGrid"></div>
      </div>

      <div class="card side">
        <div class="metric">
          <div class="k">总计收益（红+1，绿-1，可为负数）</div>
          <div class="v" id="totalScore">0</div>
          <div class="sub">
            <span class="pill"><span class="dot" style="background:var(--good)"></span>绿色次数：<b id="goodCount">0</b></span>
            <span class="pill"><span class="dot" style="background:var(--bad)"></span>红色次数：<b id="badCount">0</b></span>
            <span class="pill"><span class="dot" style="background:rgba(255,255,255,.35)"></span>未填：<b id="blankCount">0</b></span>
          </div>
        </div>

        <div class="metric">
          <div class="k">本月收益（当前视图月份）</div>
          <div class="v" id="monthScore">0</div>
          <div class="sub">
            <span class="pill">月份：<b id="monthKey">—</b></span>
            <span class="pill">记录天数：<b id="monthDays">0</b></span>
          </div>
        </div>

        <div class="metric">
          <div class="k">结款</div>
          <div class="v" id="unsettled">0</div>
          <div class="sub">
            <span class="pill">已结至：<b id="settledAt">未结</b></span>
            <span class="pill">已结金额：<b id="settledAmount">0</b></span>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn btnPrimary" id="settleBtn">结款（把当前未结置 0）</button>
            <button class="btn btnPrimary" id="exportBtn">导出 data.json</button>
            <button class="btn btnDanger" id="resetBtn">清空本地</button>
          </div>
        </div>

        <div class="metric">
          <div class="k">同步操作</div>
          <div class="sub">
            <span class="pill">1) 导出 data.json</span>
            <span class="pill">2) 覆盖仓库根目录 data.json</span>
            <span class="pill">3) git commit + push</span>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">本地编辑器会把数据暂存在浏览器 localStorage；导出后才会影响 GitHub Pages 展示。</div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const LS_KEY = "zszz_editor_v1";

    function loadLocal(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY) || "") }catch{ return null }
    }
    function saveLocal(s){
      localStorage.setItem(LS_KEY, JSON.stringify(s));
    }

    // data.json 结构：{version, data: {iso:{sleep,wake}}, settlement:{settledTotal, settledAt}}
    let state = loadLocal() || { version: 1, data: {}, settlement: { settledTotal: 0, settledAt: "" } };

    const pad2 = (n) => String(n).padStart(2, "0");
    const toISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const monthKey = (y,m) => `${y}-${pad2(m+1)}`;

    const today = new Date();
    let viewYear = today.getFullYear();
    let viewMonth = today.getMonth();

    const monthTitleEl = document.getElementById("monthTitle");
    const gridEl = document.getElementById("calendarGrid");
    const dowRowEl = document.getElementById("dowRow");

    const totalScoreEl = document.getElementById("totalScore");
    const goodCountEl = document.getElementById("goodCount");
    const badCountEl = document.getElementById("badCount");
    const blankCountEl = document.getElementById("blankCount");

    const monthScoreEl = document.getElementById("monthScore");
    const monthKeyEl = document.getElementById("monthKey");
    const monthDaysEl = document.getElementById("monthDays");

    const unsettledEl = document.getElementById("unsettled");
    const settledAtEl = document.getElementById("settledAt");
    const settledAmountEl = document.getElementById("settledAmount");

    const toastEl = document.getElementById("toast");
    let toastTimer=null;
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toastEl.classList.remove("show"), 1400);
    }

    function scoreOf(status){
      if(status === 1) return -1;
      if(status === 2) return +1;
      return 0;
    }
    function cycle(status){ return (status + 1) % 3; }
    function ensureDay(iso){
      if(!state.data[iso]) state.data[iso] = { sleep:0, wake:0 };
      return state.data[iso];
    }
    function stateLabel(s){
      if(s===1) return "成功 ✅";
      if(s===2) return "失败 ❌";
      return "未填";
    }

    function computeTotals(){
      let total=0, good=0, bad=0, blank=0;
      for(const iso in state.data){
        const d = state.data[iso] || {};
        for(const k of ["sleep","wake"]){
          const s = d[k] ?? 0;
          total += scoreOf(s);
          if(s===1) good++; else if(s===2) bad++; else blank++;
        }
      }
      return { total, good, bad, blank };
    }

    function computeMonth(){
      const mk = monthKey(viewYear, viewMonth);
      let score=0;
      let daysSet = new Set();
      for(const iso in state.data){
        if(iso.startsWith(mk)){
          const d = state.data[iso] || {};
          score += scoreOf(d.sleep ?? 0) + scoreOf(d.wake ?? 0);
          daysSet.add(iso);
        }
      }
      return { mk, score, days: daysSet.size };
    }

    function updateSidebar(){
      const { total, good, bad, blank } = computeTotals();
      totalScoreEl.textContent = String(total);
      goodCountEl.textContent = String(good);
      badCountEl.textContent = String(bad);
      blankCountEl.textContent = String(blank);

      const m = computeMonth();
      monthScoreEl.textContent = String(m.score);
      monthKeyEl.textContent = m.mk;
      monthDaysEl.textContent = String(m.days);

      const settledTotal = state.settlement?.settledTotal || 0;
      const unsettled = total - settledTotal;
      unsettledEl.textContent = String(unsettled);
      settledAmountEl.textContent = String(settledTotal);
      settledAtEl.textContent = state.settlement?.settledAt ? state.settlement.settledAt : "未结";

      totalScoreEl.style.color = (total <= 0) ? "rgba(46,204,113,.95)" : "rgba(255,77,79,.96)";
      monthScoreEl.style.color = (m.score <= 0) ? "rgba(46,204,113,.95)" : "rgba(255,77,79,.96)";
      unsettledEl.style.color = (unsettled <= 0) ? "rgba(46,204,113,.95)" : "rgba(255,77,79,.96)";
    }

    const DOW = ["一","二","三","四","五","六","日"];
    function renderDow(){
      dowRowEl.innerHTML = "";
      for(const d of DOW){
        const el = document.createElement("div");
        el.className = "dow";
        el.textContent = "周" + d;
        dowRowEl.appendChild(el);
      }
    }

    function makeSlot(label, iso, key, status){
      const slot = document.createElement("div");
      slot.className = "slot " + (status===1?"good":status===2?"bad":"blank");

      const l = document.createElement("div");
      l.className = "label";
      l.textContent = label;

      const r = document.createElement("div");
      r.className = "stateText";
      r.textContent = stateLabel(status);

      slot.appendChild(l);
      slot.appendChild(r);

    slot.addEventListener("click", ()=>{
    const cur = state.data[iso] || { sleep:0, wake:0 };
    const next = { ...cur, [key]: cycle(cur[key] ?? 0) };

    // 如果这一天两个都是 0，就从 data 里删掉，避免导出一堆 0
    if((next.sleep ?? 0) === 0 && (next.wake ?? 0) === 0){
        delete state.data[iso];
    }else{
        state.data[iso] = next;
    }

    saveLocal(state);
    renderCalendar();      // 简单粗暴：重绘一次（避免处理一堆局部更新边界）
    toast(`${iso} ${label}：${next[key]===0?"未填":next[key]===1?"成功 -1":"失败 +1"}`);
    });


      return slot;
    }

    function renderCalendar(){
      monthTitleEl.textContent = `${viewYear} 年 ${viewMonth+1} 月`;

      const first = new Date(viewYear, viewMonth, 1);
      const firstDay = first.getDay();
      const offset = (firstDay === 0) ? 6 : (firstDay - 1);

      gridEl.innerHTML = "";
      const startDate = new Date(viewYear, viewMonth, 1 - offset);

      for(let i=0;i<42;i++){
        const d = new Date(startDate);
        d.setDate(startDate.getDate()+i);

        const iso = toISO(d);
        const inMonth = d.getMonth() === viewMonth;
        const isToday = iso === toISO(new Date());

        const cell = document.createElement("div");
        cell.className = "cell" + (inMonth ? "" : " dim");

        const header = document.createElement("div");
        header.className = "dateNum";

        const left = document.createElement("span");
        left.textContent = d.getDate();
        header.appendChild(left);

        if(isToday){
          const b = document.createElement("span");
          b.className = "badgeToday";
          b.textContent = "今天";
          header.appendChild(b);
        } else {
          header.appendChild(document.createElement("span"));
        }

        const two = document.createElement("div");
        two.className = "twoSlots";

        const day = ensureDay(iso);
        two.appendChild(makeSlot("早睡", iso, "sleep", day.sleep ?? 0));
        two.appendChild(makeSlot("早起", iso, "wake",  day.wake  ?? 0));

        cell.appendChild(header);
        cell.appendChild(two);
        gridEl.appendChild(cell);
      }

      updateSidebar();
      saveLocal(state);
    }

    document.getElementById("prevMonth").addEventListener("click", ()=>{
      viewMonth--;
      if(viewMonth<0){ viewMonth=11; viewYear--; }
      renderCalendar();
    });
    document.getElementById("nextMonth").addEventListener("click", ()=>{
      viewMonth++;
      if(viewMonth>11){ viewMonth=0; viewYear++; }
      renderCalendar();
    });
    document.getElementById("jumpToday").addEventListener("click", ()=>{
      const t = new Date();
      viewYear = t.getFullYear();
      viewMonth = t.getMonth();
      renderCalendar();
      toast("已回到本月");
    });

    document.getElementById("settleBtn").addEventListener("click", ()=>{
      const { total } = computeTotals();
      state.settlement.settledTotal = total;
      state.settlement.settledAt = toISO(new Date());
      saveLocal(state);
      updateSidebar();
      toast("结款完成：未结已清零");
    });

    document.getElementById("exportBtn").addEventListener("click", ()=>{
      // 导出到 data.json（下载），你手动覆盖到仓库根目录即可
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "data.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("已导出 data.json（请覆盖仓库文件）");
    });

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      if(!confirm("确定清空本地编辑器数据吗？（不会影响 GitHub 上的 data.json）")) return;
      state = { version: 1, data: {}, settlement: { settledTotal: 0, settledAt: "" } };
      saveLocal(state);
      renderCalendar();
      toast("已清空本地");
    });

    renderDow();
    renderCalendar();
  </script>
</body>
</html>
